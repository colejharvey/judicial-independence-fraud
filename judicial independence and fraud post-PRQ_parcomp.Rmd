---
title: "Judicial independence and fraud post BJPS"
output: html_notebook
---

Note: it may be worth running the 2WFE models as multilevel models instead, as an RC. Balancing between RE and FE approaches.

```{r setup}
library(tidyverse)
library(lme4)
library(lmtest)
library(ggplot2)
library(ggeffects)
library(interplot)
#library(interactions)
library(interplot.medline)
library(interflex)
library(stargazer)
library(wfe)
library(plm)
library(ebal)
library(cowplot)
library(sjPlot)
library(fastDummies)



#####Loading dataset####
vdem.nodems <- read.csv("./vdem-2018-no-dems-parcomp-post1945-oct2020-condensed-tidy.csv") #For broader sample
#vdem.nodems <- read.csv("./vdem-2018-no-dems-post1945-polity-oct2020-condensed-tidy.csv") #For original sample

#vdem.nodems <- vdem.nodems %>% group_by(COWcode) %>% mutate(govseat.frac.lag = lag(govseat.frac, 1))
#vdem.nodems <- vdem.nodems %>% group_by(COWcode) %>% mutate(govseat.frac.2lag = lag(govseat.frac, 2))

vdem.nodems.elections <- subset(vdem.nodems, is.na(vdem.nodems$v2elirreg.inv)==FALSE)


###Coding presidential elections as majoritarian
vdem.nodems.elections <- vdem.nodems.elections %>% mutate(v2elparlel = ifelse(elexec == 1, 0, v2elparlel))

##Dummy variables for electoral system
vdem.nodems.elections <- fastDummies::dummy_cols(vdem.nodems.elections, select_columns = "v2elparlel")

vdem.nodems.elections$COW.factor <- factor(vdem.nodems.elections$COWcode)
vdem.nodems.elections$year.factor <- factor(vdem.nodems.elections$year)

vdem.nodems.elections <- vdem.nodems.elections %>% filter(parcomp.lag >= 0)
vdem.nodems.elections <- vdem.nodems.elections %>% filter(is.na(reform_positive.lag) == F)


```


```{r histogram}
p.hist <- ggplot(vdem.nodems.elections, aes(parcomp.lag, fill = factor(reform_positive.lag))) + geom_histogram(bins = 18) + 
                   guides(fill = guide_legend(title = "Treatment")) + labs(x = "Competitiveness of participation (1-year lag to treatment)", y = "Count") + scale_fill_grey() + theme_bw()

png("./Plots/treatment histogram.png", height=5,
    width=7, units="in", res=300)
p.hist + scale_x_continuous(labels = c("Unregulated", "Repressed", "Suppressed", "Factional", "Transitional", "Competitive"))
dev.off()
```



###Two-way FEs

```{r 2FE polity}
###Adjusted Polity


model.2wfe <- lm(v2elirreg.inv ~ COW.factor + year.factor +
                   reform_positive.lag + 
                   elcompindex.m.lag + elcompindex.m.lag*reform_positive.lag, data = vdem.nodems.elections)
summary(model.2wfe)

plot_model(model.2wfe, type = "eff", terms = c("elcompindex.m.lag", "reform_positive.lag"))

#interplot(model.2wfe, var1="reform_positive.lag", var2 = "elcompindex.m.lag") #Produces same results as entropy bal

interplot.medline(model.2wfe, var1="reform_positive.lag", var2 = "elcompindex.m.lag")

inter.binning(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "elcompindex.m.lag",
              FE = c("COWcode","year"), na.rm=TRUE)

mydf <- ggeffect(model.2wfe, terms = c("polity2.adj.lag", "reform_positive.lag"))

ggplot(mydf, aes(x, predicted, color = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1)

plot(mydf) #Marginal effects plot
```

```{r 2FE polity with controls, include=FALSE}
###Adjusted Polity

model.2wfe.polity <- lm(v2elirreg.inv ~ COW.factor + year.factor +
                   reform_positive.lag + loggpdpc.lag + 
                   polity2.adj.lag + polity2.adj.lag*reform_positive.lag +
                   elexec  + v2elintmon + v2elparlel_1 + v2elparlel_2 +  reform_negative.lag
                   , data = vdem.nodems.elections)
#summary(model.2wfe.polity)
```

```{r}
plot_model(model.2wfe.polity, type = "eff", terms = c("polity2.adj.lag", "reform_positive.lag"))
interactions::sim_slopes(model.2wfe.polity, pred = reform_positive.lag, modx = polity2.adj.lag, jnplot = TRUE)

p1.polity <- interplot(model.2wfe.polity, var1="reform_positive.lag", var2="polity2.adj.lag",
                      hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Adjusted Polity (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)
p1.polity
```

```{r 2FE uds with controls}

model.2wfe.uds <- lm(v2elirreg.inv ~ COW.factor + year.factor +
                   reform_positive.lag + loggpdpc.lag + 
                   uds.mean.lag + uds.mean.lag*reform_positive.lag +
                   elexec  + v2elintmon + v2elparlel_1 + v2elparlel_2 +  reform_negative.lag
                   , data = vdem.nodems.elections)
#summary(model.2wfe.uds)

plot_model(model.2wfe.uds, type = "eff", terms = c("uds.mean.lag", "reform_positive.lag"))
interactions::sim_slopes(model.2wfe.uds, pred = reform_positive.lag, modx = uds.mean.lag, jnplot = TRUE)

p1.uds <- interplot(model.2wfe.uds, var1="reform_positive.lag", var2="uds.mean.lag",
                      hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="UDS (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)
p1.uds
```

```{r 2FE elcomp with controls, include=FALSE}

model.2wfe <- lm(v2elirreg.inv ~ COW.factor + year.factor +
                   reform_positive.lag + loggpdpc.lag  +
                   elcompindex.m.lag + elcompindex.m.lag*reform_positive.lag +
                   elexec  + v2elintmon + v2elparlel_1 + v2elparlel_2 +  reform_negative.lag
                   , data = vdem.nodems.elections)
#summary(model.2wfe)
```

```{r 2FE polity with controls plots}
p1.elcomp <- interplot(model.2wfe, var1="reform_positive.lag", var2="elcompindex.m.lag",
                      hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Electoral competition multiplicative index (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)
p1.elcomp #Same as above

interactions::sim_slopes(model.2wfe, pred = reform_positive.lag, modx = elcompindex.m.lag, jnplot = TRUE)


plot_model(model.2wfe, type = "eff", terms = c("elcompindex.m.lag", "reform_positive.lag"))
#p1 <- plot_model(model.2wfe, type = "int")

#interplot.medline(model.2wfe, var1="reform_positive.lag", var2 = "polity2.adj.lag")

p1.bin <- inter.binning(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "elcompindex.m.lag", Z = c("elexec", "v2eldommon", "v2elintmon", "v2elparlel"), FE = c("COWcode", "year"),
                        na.rm=TRUE, ylab = "Marginal effect", xlab = "Electoral competition multiplicative index (1-year lag)", theme.bw = T, cex.lab = .75, cex.axis = .75, bin.labs = F) #The FE makes this plots break

p1.bin.image <- p1.bin$graph + geom_hline(yintercept = 0, linetype=2)

p1.kernel <- inter.kernel(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "elcompindex.m.lag",
              Z = c("v2elparlel", "elexec", "loggpdpc.lag", "v2eldommon", "e_mipopula"), na.rm=TRUE, FE = c("COWcode", "year"))

p1.kernel.image <- p1.kernel$graph


mydf <- ggeffect(model.2wfe, terms = c("elcompindex.m.lag", "reform_positive.lag"))

ggplot(mydf, aes(x, predicted, color = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1)

plot(mydf) #Marginal effects plot

png("./Plots/2FE elcomp-m irregularities.png", height=5,
    width=7, units="in", res=300)
p1
dev.off()
```


```{r 2FE polcon3 controls}
###2-way FE approach


model.2wfe.hpolcon.c <- lm(v2elirreg.inv ~ COW.factor + year.factor + reform_positive.lag + loggpdpc.lag + 
                                 h_polcon3.lag + reform_positive.lag*h_polcon3.lag +
                   elexec +  v2elintmon + v2elparlel_1 + v2elparlel_2 +  reform_negative.lag, data = vdem.nodems.elections)

#summary(model.2wfe.hpolcon.c)

plot_model(model.2wfe.hpolcon.c, type="eff", terms = c("h_polcon3.lag", "reform_positive.lag"))

interactions::sim_slopes(model.2wfe.hpolcon.c, pred = reform_positive.lag, modx = h_polcon3.lag, jnplot = TRUE)

p1.polcon <- interplot(model.2wfe.hpolcon.c, var1="reform_positive.lag", var2="h_polcon3.lag",
                      hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Electoral competition multiplicative index (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2) 

p1.polcon
```


```{r 2FE legislative-oversight, include = FALSE}
###2-way FE approach
vdem.nodems.elections$COW.factor <- factor(vdem.nodems.elections$COWcode)
vdem.nodems.elections$year.factor <- factor(vdem.nodems.elections$year)

model.2wfe.legov <- lm(v2elirreg.inv ~ COW.factor + year.factor + reform_positive.lag + 
                                 opposition.oversight.lag + reform_positive.lag*opposition.oversight.lag, data = vdem.nodems.elections)

#summary(model.2wfe.legov)
#interplot(model.2wfe.legov, var1="reform_positive.lag", var2 = "opposition.oversight.lag") #Produces same results as entropy bal
#interplot.medline(model.2wfe.legov, var1="reform_positive.lag", var2 = "opposition.oversight.lag")

```

```{r 2FE legislative-oversight plots}
inter.binning(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "opposition.oversight.lag",
              FE = c("COWcode","year"), na.rm=TRUE)

mydf <- ggeffect(model.2wfe.legov, terms = c("opposition.oversight.lag", "reform_positive.lag"))

ggplot(mydf, aes(x, predicted, color = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1)

plot(mydf) #Marginal effects plot
```


```{r 2FE legislative-oversight controls, include = FALSE}
###2-way FE approach

model.2wfe.legov.c <- lm(v2elirreg.inv ~ COW.factor + year.factor + reform_positive.lag + loggpdpc.lag + 
                                 opposition.oversight.lag + reform_positive.lag*opposition.oversight.lag +
                   elexec +  v2elintmon + v2elparlel_1 + v2elparlel_2  + reform_negative.lag, data = vdem.nodems.elections)

#summary(model.2wfe.legov.c)
#interplot(model.2wfe.legov, var1="reform_positive.lag", var2 = "opposition.oversight.lag") #Produces same results as entropy bal
#interplot.medline(model.2wfe.legov, var1="reform_positive.lag", var2 = "opposition.oversight.lag")

```

```{r 2FE legislative-oversight controls plots}
p1.legov <- interplot(model.2wfe.legov.c, var1="reform_positive.lag", var2="opposition.oversight.lag",
                      hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Opposition oversight (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)  #Same as ab

p1.legov 

plot_model(model.2wfe.legov.c, type="eff", terms = c("opposition.oversight.lag", "reform_positive.lag"))

interactions::sim_slopes(model.2wfe.legov.c, pred = reform_positive.lag, modx = opposition.oversight.lag, jnplot = TRUE)

p2.bin <- inter.binning(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "opposition.oversight.lag", Z = c("elexec", "v2eldommon", "v2elparlel"),
              FE = c("COWcode","year"), na.rm=TRUE, ylab = "Marginal effect", xlab = "Opposition oversight (lag)", theme.bw = T, cex.lab = .75, cex.axis = .75, bin.labs = F)


p2.bin.image <- p2.bin$graph + geom_hline(yintercept = 0, linetype=2)
p2.bin.image

p2.kernel <- inter.kernel(data=vdem.nodems.elections, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "opposition.oversight.lag",
             Z = c("elexec", "v2eldommon", "v2elparlel"), na.rm=TRUE, FE = c("COWcode", "year"), ylab = "Marginal effect", xlab = "Opposition oversight (lag)", theme.bw = T)

p2.kernel.image <- p2.kernel$graph


mydf <- ggpredict(model.2wfe.legov.c, terms = c("opposition.oversight.lag", "reform_positive.lag"))

ggplot(mydf, aes(x, predicted, color = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .1)

plot(mydf) #Marginal effects plot

png("./Plots/2FE oversight irregularities.png", height=5,
    width=7, units="in", res=300)
p2
dev.off()
```

###Ebal with unit FE

Polity

```{r ebal polity, include=FALSE}
myvars <- c("COW.factor", "year.factor", "transitional", "v2elirreg.inv", "v2elintim.inv", "lc.ind.2lag", "hc.ind.2lag", "oppaut.2lag", "elexec", "education.2lag",  "v2elparlel_1", "v2elparlel_2", "lji.2lag", "v2elparlel_3",
            "polity2.adj.lag", "polity2.adj.2lag", "urban.2lag",  "v2elintmon", 
            "country_name", "reform_positive.lag", "loggpdpc.2lag", "reform_negative.lag", "reform_negative.2lag", "purge.lag", "pack.lag",
            "democracy.duration.2lag", "exec.respectcon.2lag", "leg.constraints.2lag", 
            "altinfo.2lag", "loggpdpc.lag")  # "e_van_comp.lag  , "party.institutionalization.lag" ....... "parcomp.lag", "polcomp.lag"

dataset.matching <- vdem.nodems.elections[myvars]
dataset.matching.complete <- na.omit(dataset.matching)


myvars <- c("democracy.duration.2lag", "oppaut.2lag",  "polity2.adj.2lag", "lji.2lag",
             "loggpdpc.2lag", "urban.2lag", "reform_negative.2lag",
            "hc.ind.2lag",  "lc.ind.2lag", "transitional", "exec.respectcon.2lag", "altinfo.2lag", "education.2lag",
            "leg.constraints.2lag")  #"lji.lag"
ebal.covariates <- dataset.matching.complete[myvars]
#ebal.covariates.var <- ebal.covariates

ebal.test <- ebalance(Treatment=dataset.matching.complete$reform_positive.lag, X = ebal.covariates)



# means in treatment group data
t.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==1,],2,mean)
# means in reweighted control group data
c.means.bal <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,weighted.mean,w=ebal.test$w)
# means in raw data control group data
c.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,mean)
#library(stargazer)
#stargazer(cbind(t.means, c.means.bal, c.means), type="html", 
#          out="./Drafts/ebal adjusted means full data.html")



dataset.matching.complete.controls <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 0)
dataset.matching.complete.controls <- data.frame(cbind(dataset.matching.complete.controls, ebal.test$w))
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% mutate(ebal.test.w = ...25)
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% dplyr::select(-...25)


dataset.matching.complete.treat <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 1)
dataset.matching.complete.treat$ebal.test.w <- 1

dataset.matching.complete.w <- bind_rows(dataset.matching.complete.treat, dataset.matching.complete.controls)


###regression
elirreg.posreform.polity.base <- lm(v2elirreg.inv~reform_positive.lag +
                                        
                                        polity2.adj.lag  + elexec +  v2elparlel_1 + v2elparlel_2  +
                                            #e_polity2 +
                                            #e_miurbani + 
                                            v2elintmon + 
                                             reform_negative.lag + purge.lag + pack.lag + loggpdpc.lag +
                                      COW.factor, 
                                    weights=ebal.test.w,  
                                    data = dataset.matching.complete.w)
#summary(elirreg.posreform.polity.base)


mm.elirreg.posreform.polity.all <- lm(v2elirreg.inv~reform_positive.lag
                                        + 
                                          polity2.adj.lag +
                                      reform_positive.lag*polity2.adj.lag
                                      + elexec + v2elparlel_1 + v2elparlel_2 + 
                                              # e_polity2 +
                                              #e_miurbani + 
                                              v2elintmon + 
                                              reform_negative.lag + purge.lag + pack.lag  + loggpdpc.lag +
                                     COW.factor,  
                                            weights=ebal.test.w,
                                            data = dataset.matching.complete.w)
#summary(mm.elirreg.posreform.polity.all)

lrtest(elirreg.posreform.polity.base, mm.elirreg.posreform.polity.all)

```

```{r plot ebal polity}
p2.polity <- interplot(mm.elirreg.posreform.polity.all, var1="reform_positive.lag", var2="polity2.adj.lag",
                hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Adjusted Polity \n(1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)   #No effect for fraud
p2.polity

interactions::sim_slopes(mm.elirreg.posreform.polity.all, pred = reform_positive.lag, modx = polity2.adj.lag, jnplot = TRUE)


plot_model(mm.elirreg.posreform.polity.all, type="eff", terms = c("polity2.adj.lag", "reform_positive.lag"))


p3.bin <- inter.binning(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "polity2.adj.lag",
              Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "reform_negative.lag"), weights = "ebal.test.w", na.rm=TRUE,  ylab = "Marginal effect", xlab = "Adjusted Polity score (lag)", theme.bw = T, cex.lab = .75, cex.axis = .75, bin.labs = F)

p3.bin.image <- p3.bin$graph + geom_hline(yintercept = 0, linetype=2)

p3.kernel <- inter.kernel(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "polity2.adj.lag",
              Z = c("v2elparlel", "elexec", "loggpdpc.lag", "v2eldommon", "e_mipopula"), weights = "ebal.test.w", na.rm=TRUE, FE = c("COWcode"))

p3.kernel.image <- p3.kernel$graph


png("./Plots/ebal elcomp.m irregularities.png", height=5,
    width=7, units="in", res=300)
p3
dev.off()

```

Elcomp

```{r ebal elcomp, include=FALSE}



myvars <- c("COW.factor", "year", "transitional", "v2elirreg.inv", "v2elintim.inv", "lc.ind.2lag",  "hc.ind.2lag", "oppaut.2lag", "elexec", "education.2lag",  "v2elparlel_1", "v2elparlel_2", "lji.2lag", "v2elparlel_3", "purge.lag", "pack.lag",
            "elcompindex.m.lag", "elcompindex.m.2lag", "urban.2lag",  "v2elintmon", 
            "country_name", "reform_positive.lag", "loggpdpc.2lag", "reform_negative.lag",
            "democracy.duration.2lag", "exec.respectcon.2lag", "leg.constraints.2lag", 
            "altinfo.2lag", "loggpdpc.lag")  # "e_van_comp.lag  , "party.institutionalization.lag" ....... "parcomp.lag", "polcomp.lag"

dataset.matching <- vdem.nodems.elections[myvars]
dataset.matching.complete <- na.omit(dataset.matching)


myvars <- c("democracy.duration.2lag", "oppaut.2lag",  "elcompindex.m.2lag", "lji.2lag",
             "loggpdpc.2lag", "urban.2lag",
            "hc.ind.2lag",  "lc.ind.2lag", "transitional", "exec.respectcon.2lag", "altinfo.2lag", "education.2lag",
            "leg.constraints.2lag")  #"lji.lag"
ebal.covariates <- dataset.matching.complete[myvars]
#ebal.covariates.var <- ebal.covariates

ebal.test <- ebalance(Treatment=dataset.matching.complete$reform_positive.lag, X = ebal.covariates)



# means in treatment group data
t.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==1,],2,mean)
# means in reweighted control group data
c.means.bal <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,weighted.mean,w=ebal.test$w)
# means in raw data control group data
c.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,mean)
#library(stargazer)
#stargazer(cbind(t.means, c.means.bal, c.means), type="html", 
#          out="./Drafts/ebal adjusted means full data.html")



dataset.matching.complete.controls <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 0)
dataset.matching.complete.controls <- data.frame(cbind(dataset.matching.complete.controls, ebal.test$w))
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% mutate(ebal.test.w = ...25)
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% dplyr::select(-...25)


dataset.matching.complete.treat <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 1)
dataset.matching.complete.treat$ebal.test.w <- 1

dataset.matching.complete.w <- bind_rows(dataset.matching.complete.treat, dataset.matching.complete.controls)


###regression
elirreg.posreform.elcomp.base <- lm(v2elirreg.inv~reform_positive.lag +
                                        
                                        elcompindex.m.lag  + elexec +  v2elparlel_1 + v2elparlel_2 + 
                                            #e_polity2 +
                                        loggpdpc.lag + 
                                            #e_miurbani + 
                                            v2elintmon +  
                                            reform_negative.lag + purge.lag + pack.lag+
                                      COW.factor, 
                                    weights=ebal.test.w,  
                                    data = dataset.matching.complete.w)
#summary(elirreg.posreform.elcomp.base)


mm.elirreg.posreform.elcomp.all <- lm(v2elirreg.inv~reform_positive.lag
                                        + 
                                          elcompindex.m.lag +
                                      reform_positive.lag*elcompindex.m.lag
                                      + elexec + v2elparlel_1 + v2elparlel_2 + 
                                              # e_polity2 +
                                          loggpdpc.lag + 
                                              #e_miurbani + 
                                              v2elintmon + 
                                          reform_negative.lag+ purge.lag + pack.lag+
                                     COW.factor,  
                                            weights=ebal.test.w,
                                            data = dataset.matching.complete.w)
#summary(mm.elirreg.posreform.elcomp.all)

lrtest(elirreg.posreform.elcomp.base, mm.elirreg.posreform.elcomp.all)

```

```{r plot ebal elcomp}
p2.elcomp <- interplot(mm.elirreg.posreform.elcomp.all, var1="reform_positive.lag", var2="elcompindex.m.lag",
                hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Political openness \n(1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)   #No effect for fraud
p2.elcomp

interactions::sim_slopes(mm.elirreg.posreform.elcomp.all, pred = reform_positive.lag, modx = elcompindex.m.lag, jnplot = TRUE)


plot_model(mm.elirreg.posreform.elcomp.all, type="eff", terms = c("elcompindex.m.lag", "reform_positive.lag"))


p3.bin.elcomp <- inter.binning(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "elcompindex.m.lag",
              Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE,  ylab = "Marginal effect", xlab = "Political openness (lag)", theme.bw = T, cex.lab = .75, cex.axis = .75, bin.labs = F)

p3.bin.image.elcomp <- p3.bin.elcomp$graph + geom_hline(yintercept = 0, linetype=2)

p3.kernel <- inter.kernel(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "elcompindex.m.lag",
               Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE,  ylab = "Marginal effect", xlab = "Political openness (lag)", theme.bw = T)

p3.kernel.image.elcomp <- p3.kernel$graph #Kernel is good


png("./Plots/ebal elcomp.m irregularities.png", height=5,
    width=7, units="in", res=300)
p3
dev.off()

```



```{r include=FALSE}
### Legislative opposition oversight
myvars <- c("COW.factor", "year.factor", "transitional", "v2elirreg.inv", "v2elintim.inv", "lc.ind.2lag", 
            "hc.ind.2lag", "oppaut.2lag", "elexec", "education.2lag",  "lji.2lag", "pack.lag", "purge.lag",
            "opposition.oversight.lag", "opp.oversight.2lag", "urban.2lag", "v2elmulpar", "v2elintmon", 
            "country_name", "reform_positive.lag", "loggpdpc.2lag", "reform_negative.lag",
            "democracy.duration.2lag", "exec.respectcon.2lag", "leg.constraints.2lag", 
            "altinfo.2lag", "loggpdpc.lag", "years.since.election",  "v2elparlel_1", "v2elparlel_2",  "v2elparlel_3")  # "e_van_comp.lag  , "party.institutionalization.lag" ....... "parcomp.lag", "polcomp.lag"

dataset.matching <- vdem.nodems.elections[myvars]
dataset.matching.complete <- na.omit(dataset.matching)


myvars <- c("democracy.duration.2lag", "oppaut.2lag",  "opp.oversight.2lag", "lji.2lag",
            "loggpdpc.2lag", "urban.2lag",
            "hc.ind.2lag",  "lc.ind.2lag", "transitional", "exec.respectcon.2lag", "altinfo.2lag", "education.2lag",
            "leg.constraints.2lag")  #"lji.lag"
ebal.covariates <- dataset.matching.complete[myvars]
#ebal.covariates.var <- ebal.covariates

ebal.test <- ebalance(Treatment=dataset.matching.complete$reform_positive.lag, X = ebal.covariates)




# means in treatment group data
t.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==1,],2,mean)
# means in reweighted control group data
c.means.bal <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,weighted.mean,w=ebal.test$w)
# means in raw data control group data
c.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,mean)


dataset.matching.complete.controls <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 0)
dataset.matching.complete.controls <- data.frame(cbind(dataset.matching.complete.controls, ebal.test$w))
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% mutate(ebal.test.w = ...27)
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% dplyr::select(-...27)


dataset.matching.complete.treat <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 1)
dataset.matching.complete.treat$ebal.test.w <- 1

dataset.matching.complete.w <- bind_rows(dataset.matching.complete.treat, dataset.matching.complete.controls)


stargazer(cbind(t.means, c.means.bal, c.means), type="html", 
          out="./Drafts/ebal adjusted means full data.html")

###regression
elirreg.posreform.oversight.base <- lm(v2elirreg.inv~reform_positive.lag +
                                               opposition.oversight.lag + elexec + 
                                               #e_polity2 +
                                           loggpdpc.lag + 
                                               #e_miurbani + 
                                               v2elintmon + 
                                            v2elparlel_1 + v2elparlel_2 +  reform_negative.lag + purge.lag + pack.lag+
                                         COW.factor#+ transitional + altinfo.lag
                                             , weights=ebal.test.w,
                                             data = dataset.matching.complete.w)
#summary(elirreg.posreform.oversight.base)


mm.elirreg.posreform.oversight <- lm(v2elirreg.inv~reform_positive.lag +
                                             opposition.oversight.lag + reform_positive.lag*opposition.oversight.lag   + elexec + 
                                             # e_polity2 +
                                         loggpdpc.lag + 
                                             #e_miurbani + 
                                              v2elintmon + 
                                              v2elparlel_1 + v2elparlel_2   + reform_negative.lag + purge.lag + pack.lag+
 #+ transitional + altinfo.lag 
                                      COW.factor, 
                                           weights=ebal.test.w,
                                           data = dataset.matching.complete.w)
#summary(mm.elirreg.posreform.oversight)

```


```{r}
#summary(mm.elirreg.posreform.oversight)
summary(dataset.matching.complete.w$opposition.oversight.lag)
meffect1 <-  (-0.27 * -0.7151)  #Treat = 0
meffect2 <-  (-0.27 * -0.7151) +  (-0.35 * 1)  + (.135 * -0.7151) #Treat = 1
meffect2 - meffect1

summary(dataset.matching.complete.w$v2elirreg.inv)
(meffect2 - meffect1) / (2.86 - (-2.55))

meffect3 <-  (-0.27 * -.7151)  #Treatment constant at 0, change in oversight
meffect4 <-  (-0.27 * .2857)

meffect4 - meffect3

```



```{r}
p2.legov <- interplot(mm.elirreg.posreform.oversight, var1="reform_positive.lag", var2="opposition.oversight.lag",
                hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Opposition oversight \n(1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)   
p2.legov

interactions::sim_slopes(mm.elirreg.posreform.oversight, pred = reform_positive.lag, modx = opposition.oversight.lag, jnplot = TRUE)


plot_model(mm.elirreg.posreform.oversight, type="eff", terms = c("opposition.oversight.lag", "reform_positive.lag"))


p4.bin.osight <- inter.binning(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "opposition.oversight.lag",
             Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE, ylab = "Marginal effect", xlab = "Opposition oversight (lag)", theme.bw = T, cex.lab = .75, cex.axis = .75, bin.labs = F)

p4.bin.image.osight <- p4.bin.osight$graph + geom_hline(yintercept = 0, linetype=2)

p4.kernel.osight <- inter.kernel(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "opposition.oversight.lag",
              Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE, ylab = "Marginal effect", xlab = "Opposition oversight (lag)", theme.bw = T)

p4.kernel.image.osight <- p4.kernel.osight$graph

png("./Plots/ebal oversight kernel plot.png", height=5,
    width=7, units="in", res=300)
p4.kernel.image
dev.off()


png("./Plots/ebal oversight irregularities.png", height=5,
    width=7, units="in", res=300)
p4
dev.off()
```


##UDS

```{r ebal polity, include=FALSE}
myvars <- c("COW.factor", "year.factor", "transitional", "v2elirreg.inv", "v2elintim.inv", "lc.ind.2lag", "lji.2lag", "hc.ind.2lag", "oppaut.2lag", "elexec", "education.2lag",  "v2elparlel_1", "v2elparlel_2", "v2elparlel_3", "pack.lag", "purge.lag",
            "uds.mean.lag", "uds.mean.2lag", "urban.2lag",  "v2elintmon", 
            "country_name", "reform_positive.lag", "loggpdpc.2lag", "reform_negative.lag",
            "democracy.duration.2lag", "exec.respectcon.2lag", "leg.constraints.2lag", 
            "altinfo.2lag", "loggpdpc.lag")  # "e_van_comp.lag  , "party.institutionalization.lag" ....... "parcomp.lag", "polcomp.lag"

dataset.matching <- vdem.nodems.elections[myvars]
dataset.matching.complete <- na.omit(dataset.matching)


myvars <- c("democracy.duration.2lag", "oppaut.2lag",  "uds.mean.2lag",
             "loggpdpc.2lag", "urban.2lag",
            "hc.ind.2lag",  "lc.ind.2lag", "transitional", "exec.respectcon.2lag", "altinfo.2lag", "education.2lag", "lji.2lag",
            "leg.constraints.2lag")  #"lji.lag"
ebal.covariates <- dataset.matching.complete[myvars]
#ebal.covariates.var <- ebal.covariates

ebal.test <- ebalance(Treatment=dataset.matching.complete$reform_positive.lag, X = ebal.covariates)



# means in treatment group data
t.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==1,],2,mean)
# means in reweighted control group data
c.means.bal <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,weighted.mean,w=ebal.test$w)
# means in raw data control group data
c.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,mean)
#library(stargazer)
#stargazer(cbind(t.means, c.means.bal, c.means), type="html", 
#          out="./Drafts/ebal adjusted means full data.html")



dataset.matching.complete.controls <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 0)
dataset.matching.complete.controls <- data.frame(cbind(dataset.matching.complete.controls, ebal.test$w))
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% mutate(ebal.test.w = ...25)
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% dplyr::select(-...25)


dataset.matching.complete.treat <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 1)
dataset.matching.complete.treat$ebal.test.w <- 1

dataset.matching.complete.w <- bind_rows(dataset.matching.complete.treat, dataset.matching.complete.controls)


###regression
elirreg.posreform.uds.base <- lm(v2elirreg.inv~reform_positive.lag +
                                        
                                         elexec +  v2elparlel_1 + v2elparlel_2 + 
                                            #e_polity2 +
                                            #e_miurbani + 
                                            v2elintmon +  
                                           reform_negative.lag + purge.lag + pack.lag + loggpdpc.lag +
                                      COW.factor, 
                                    weights=ebal.test.w,  
                                    data = dataset.matching.complete.w)
#summary(elirreg.posreform.polity.base)


mm.elirreg.posreform.uds.all <- lm(v2elirreg.inv~reform_positive.lag
                                        + 
                                      reform_positive.lag*uds.mean.lag
                                      + elexec + v2elparlel_1 + v2elparlel_2 + 
                                              # e_polity2 +
                                              #e_miurbani + 
                                              v2elintmon + 
                                             reform_negative.lag + loggpdpc.lag + + purge.lag + pack.lag+
                                     COW.factor,  
                                            weights=ebal.test.w,
                                            data = dataset.matching.complete.w)
#summary(mm.elirreg.posreform.polity.all)

lrtest(elirreg.posreform.uds.base, mm.elirreg.posreform.uds.all)

```

```{r plot ebal uds}
interactions::sim_slopes(mm.elirreg.posreform.uds.all, pred = reform_positive.lag, modx = uds.mean.lag, jnplot = TRUE)


plot_model(mm.elirreg.posreform.uds.all, type="eff", terms = c("uds.mean.lag", "reform_positive.lag"))

p2.uds <- interplot(mm.elirreg.posreform.uds.all, var1="reform_positive.lag", var2="uds.mean.lag",
                hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Unified Democracy Score \n(1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)   
p2.uds

p4.kernel.uds <- inter.kernel(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "uds.mean.lag",
              Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE, ylab = "Marginal effect", xlab = "UDS (lag)", theme.bw = T)

p4.kernel.image.uds <- p4.kernel.uds$graph
```

Polcon3

```{r ebal polcon, include=FALSE}
vdem.nodems.elections <- vdem.nodems.elections %>% mutate(scale.polcon.lag = log(h_polcon3.lag))
myvars <- c("COW.factor", "year.factor", "transitional", "v2elirreg.inv", "v2elintim.inv", "lc.ind.2lag", "lji.2lag", "hc.ind.2lag", "oppaut.2lag", "elexec", "education.2lag",  "v2elparlel_1", "v2elparlel_2",                        "h_polcon3.lag", "h_polcon3.2lag",
             "urban.2lag",  "v2elintmon", "pack.lag", "purge.lag",
            "country_name", "reform_positive.lag", "loggpdpc.2lag", "reform_negative.lag",
            "democracy.duration.2lag", "exec.respectcon.2lag", "leg.constraints.2lag", 
            "altinfo.2lag", "loggpdpc.lag")  # "e_van_comp.lag  , "party.institutionalization.lag" ....... "parcomp.lag", "polcomp.lag"

dataset.matching <- vdem.nodems.elections[myvars]
dataset.matching.complete <- na.omit(dataset.matching)


myvars <- c("democracy.duration.2lag", "oppaut.2lag",  "h_polcon3.2lag", "lji.2lag",
             "loggpdpc.2lag", "urban.2lag",
            "hc.ind.2lag",  "lc.ind.2lag", "transitional", "exec.respectcon.2lag", "altinfo.2lag", "education.2lag",
            "leg.constraints.2lag")  #"lji.lag"
ebal.covariates <- dataset.matching.complete[myvars]
#ebal.covariates.var <- ebal.covariates

ebal.test <- ebalance(Treatment=dataset.matching.complete$reform_positive.lag, X = ebal.covariates)



# means in treatment group data
t.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==1,],2,mean)
# means in reweighted control group data
c.means.bal <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,weighted.mean,w=ebal.test$w)
# means in raw data control group data
c.means <- apply(ebal.covariates[dataset.matching.complete$reform_positive.lag==0,],2,mean)
#library(stargazer)
#stargazer(cbind(t.means, c.means.bal, c.means), type="html", 
#          out="./Drafts/ebal adjusted means full data.html")



dataset.matching.complete.controls <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 0)
dataset.matching.complete.controls <- data.frame(cbind(dataset.matching.complete.controls, ebal.test$w))
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% mutate(ebal.test.w = ...25)
#dataset.matching.complete.controls <- dataset.matching.complete.controls %>% dplyr::select(-...25)


dataset.matching.complete.treat <- subset(dataset.matching.complete, dataset.matching.complete$reform_positive.lag == 1)
dataset.matching.complete.treat$ebal.test.w <- 1

dataset.matching.complete.w <- bind_rows(dataset.matching.complete.treat, dataset.matching.complete.controls)


###regression
elirreg.posreform.polcon.base <- lm(v2elirreg.inv~reform_positive.lag +
                                        
                                        h_polcon3.lag  + elexec +  v2elparlel_1 + v2elparlel_2  +
                                            #e_polity2 +
                                            #e_miurbani + 
                                            v2elintmon +  
                                           reform_negative.lag + loggpdpc.lag + purge.lag + pack.lag+
                                      COW.factor, 
                                    weights=ebal.test.w,  
                                    data = dataset.matching.complete.w)
#summary(elirreg.posreform.polity.base)


mm.elirreg.posreform.polcon.all <- lm(v2elirreg.inv~reform_positive.lag
                                        + 
                                          h_polcon3.lag +
                                      reform_positive.lag*h_polcon3.lag
                                      + elexec + v2elparlel_1 + v2elparlel_2  +
                                              # e_polity2 +
                                            #e_miurbani + 
                                              v2elintmon + 
                                               reform_negative.lag + loggpdpc.lag + purge.lag + pack.lag+
                                     COW.factor,  
                                            weights=ebal.test.w,
                                            data = dataset.matching.complete.w)
#summary(mm.elirreg.posreform.polcon.all)


```


```{r plot ebal polcon}
interactions::sim_slopes(mm.elirreg.posreform.polcon.all, pred = reform_positive.lag, modx = h_polcon3.lag, jnplot = TRUE)


plot_model(mm.elirreg.posreform.polcon.all, type="eff", terms = c("h_polcon3.lag", "reform_positive.lag"))

p4.polcon <- interplot(mm.elirreg.posreform.polcon.all, var1="reform_positive.lag", var2="h_polcon3.lag",
                hist=TRUE, adjCI = TRUE) + theme_bw() + labs(x="Political constraints (1-year lag)", y="Marginal effect") +
  geom_hline(yintercept=0, linetype=2)   
p4.polcon

p4.kernel.polcon <- inter.kernel(data=dataset.matching.complete.w, Y = "v2elirreg.inv", D = "reform_positive.lag", X = "h_polcon3.lag",
              Z = c("elexec", "loggpdpc.lag", "v2elintmon", "v2elparlel_1", "v2elparlel_2", "purge.lag",
                    "pack.lag", "reform_negative.lag"), FE = "COW.factor", weights = "ebal.test.w", na.rm=TRUE, ylab = "Marginal effect", xlab = "Political constraints (lag)", theme.bw = T)

p4.kernel.image.polcon <- p4.kernel.polcon$graph
```

Combined plot for unbalanced data
```{r combining me plots}
p.combined.unb <- cowplot::plot_grid(p1.elcomp, p1.legov, p1.polity, p1.uds, align = "hv", nrow = 2, label_size = 12, hjust = 0)
p.combined.unb

png("./Plots/marginal effects plots combined unbalanced.png", height=5,
    width=7, units="in", res=300)
p.combined.unb
dev.off()
```

Combined plot for entropy balanced data
```{r combining me plots}
p.combined.ebal <- cowplot::plot_grid(p2.elcomp, p2.legov, p4.polcon, align = "hv", nrow = 2, label_size = 12, hjust = 0)
p.combined.ebal

png("./Plots/marginal effects plots combined ebal.png", height=5,
    width=7, units="in", res=300)
p.combined.ebal
dev.off()
```



```{r combining validation plots}
p.combined.ints <- cowplot::plot_grid(p3.kernel$graph, p4.kernel.osight$graph, p4.kernel.polcon$graph, align = "hv", nrow = 2, label_size = 12, hjust = 0)
p.combined.ints

png("./Plots/validation plots combined.png", height=5,
    width=7, units="in", res=300)
p.combined.ints
dev.off()
```



##Tables

```{r}
#Unbalanced
stargazer(model.2wfe, model.2wfe.legov.c, model.2wfe.polity,
          model.2wfe.uds,
          digits = 2, omit = c("COW.factor", "COWcode", "year.factor", "year"),
          type="html", out="./Drafts/main results irreg unbalanced.html")

```


```{r}
#Entropy balanced
stargazer(mm.elirreg.posreform.elcomp.all, mm.elirreg.posreform.oversight, mm.elirreg.posreform.polcon.all,
          digits = 2, omit = c("COW.factor", "COWcode", "year.factor", "year"),
          type="html", out="./Drafts/main results irreg ebal.html")

```


##Robustness checks


###Alternative measures of independence: LJI + jucon and HC/LC ind from Vdem

```{r lji, include=FALSE}
judicial <- read.csv("./LJI-estimates-20140422.csv")
vdem.nodems$lji <- NA
vdem.nodems$lji.lag <- NA
vdem.nodems$lji.2lag <- NA
i <- 1

for(i in 1:nrow(vdem.nodems)){
  tryCatch({
    cow <- as.numeric(vdem.nodems$COW[i])
    group <- subset(judicial, judicial$ccode == cow)
    loopyear <- as.numeric(vdem.nodems$year[i])
    lag.year <- loopyear - 1
    lag.year2 <- lag.year - 1
    #if (group$year == loopyear) mergeddata$lji[i] <- group.year$LJI else mergeddata$lji <- NA
    group.year <- subset(group, group$year == loopyear)
    vdem.nodems$lji[i] <- group.year$LJI
    group.year <- subset(group, group$year == lag.year)
    vdem.nodems$lji.lag[i] <- group.year$LJI
    group.year <- subset(group, group$year == lag.year2)
    vdem.nodems$lji.2lag[i] <- group.year$LJI
  }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}

```


###LJI by opp oversight, no balancing because not a binary treatment, with FE

```{r elcompindex}
mm.elirreg.lji.elcomp.base <- lm(v2elirreg.inv~lji.lag +
                                  elcompindex.m.lag + elexec +
                                  #e_peaveduc+ 
                                  #e_polity2 +
                                  #e_migdppcln + 
                                  #e_miurbani + 
                                  v2eldommon + v2elmulpar
                                  #log(e_mipopula) 
                                + transitional
                                
                                + factor(COWcode),
                                data = vdem.nodems)
summary(mm.elirreg.lji.elcomp.base)

mm.elirreg.lji.elcomp <- lm(v2elirreg.inv~lji.lag +
                             elcompindex.m.lag + lji.lag*elcompindex.m.lag   + elexec +
                            # e_peaveduc+ 
                             #e_polity2 +
                             #e_migdppcln + 
                             #e_miurbani + 
                             v2eldommon + v2elmulpar
                             #+log(e_mipopula) 
                           + transitional
                           
                           + factor(COWcode),
                           data = vdem.nodems)
summary(mm.elirreg.lji.elcomp)
interplot(mm.elirreg.lji.elcomp, var1 = "lji.lag", var2 = "elcompindex.m.lag")

```


```{r lji_opp_oversight_FE}
mm.elirreg.lji.opp.base <- lm(v2elirreg.inv~lji.lag +
                                  opposition.oversight.lag + elexec +
                                  #e_peaveduc+ 
                                  #e_polity2 +
                                  #e_migdppcln + 
                                  #e_miurbani + 
                                  v2eldommon + v2elmulpar
                                  #log(e_mipopula) 
                                + transitional
                                
                                + factor(COWcode),
                                data = vdem.nodems)
summary(mm.elirreg.lji.opp.base)

mm.elirreg.lji.opp <- lm(v2elirreg.inv~lji.lag +
                             opposition.oversight.lag + lji.lag*opposition.oversight.lag   + elexec +
                            # e_peaveduc+ 
                             #e_polity2 +
                             #e_migdppcln + 
                             #e_miurbani + 
                             v2eldommon + v2elmulpar
                             #+log(e_mipopula) 
                           + transitional
                           
                           + factor(COWcode),
                           data = vdem.nodems)
summary(mm.elirreg.lji.opp)
p.lji.opp <- interplot(mm.elirreg.lji.opp, var1="lji.lag", var2="opposition.oversight.lag", hist=TRUE) +
  labs(x="Opposition oversight (lagged)", y="Marginal effect", title="Latent judicial independence") + 
  theme_bw() + geom_hline(yintercept=0, linetype=2)
p.lji.opp

inter.binning(data=vdem.nodems, Y = "v2elirreg.inv", D = "lji.lag", X = "opposition.oversight.lag",
              Z = c( "elexec", "v2eldommon", "transitional", "v2elmulpar"), na.rm=TRUE, FE = c("COWcode"))

inter.kernel(data=vdem.nodems, Y = "v2elirreg.inv", D = "lji.lag", X = "opposition.oversight.lag",
              Z = c("elexec", "v2eldommon", "transitional", "v2elmulpar"), na.rm=TRUE, FE = c("COWcode"))
```







###For possible use of Imai et al method

```{r}
test.sub <- vdem.nodems.elections %>% group_by(COWcode) %>% filter(length(unique(reform_positive.lag)) > 1)

test.sub <- test.sub %>% group_by(year) %>% filter(length(unique(reform_positive.lag)) > 1)

test.sub <- data.frame(test.sub)
```

```{r weighted 2FE using small dataset}
model.2wfe.w <- wfe(v2elirreg.inv ~  reform_positive.lag + elexec + 
                                     #loggpdpc.lag + 
                                     v2eldommon + v2elmulpar +
                                     #log(e_mipopula) +
                                     polity2.adj.lag + 
                                     reform_positive.lag*polity2.adj.lag, data = test.sub,
                                     unit.index = "COWcode", time.index = "year", treat = "reform_positive.lag",
                                     estimator = "Mdid", qoi = "ate")
#summary(model.2wfe.w)  #Even with this data, still produces bad SEs
inter.binning(data = test.sub, Y = "v2elirreg.inv",  D = "reform_positive.lag", X = "polity2.adj.lag", Z = c("elexec", "v2eldommon", "v2elmulpar"),
              FE = c("COWcode","year"), na.rm=TRUE)

inter.kernel(data = test.sub, Y = "v2elirreg.inv",  D = "reform_positive.lag", X = "polity2.adj.lag", Z = c("elexec", "v2eldommon", "v2elmulpar"),
              FE = c("COWcode","year"), na.rm=TRUE)
```


